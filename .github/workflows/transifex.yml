name: Synchronize with Transifex
on:
    workflow_dispatch:
    schedule:
        - cron: "00 23 * * *"
    push:
        branches: main
        paths:
            - _locales/**.json

jobs:
    sync:
        name: Synchronize
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              if: always()
              uses: actions/checkout@main
              with:
                  ref: ${{github.head_ref}}
                  token: ${{secrets.WGYTBOT}}

            - name: Setup Python
              if: always()
              uses: actions/setup-python@main
              with:
                  python-version: 3.x

            - name: Install
              if: always()
              run: pip install transifex-client

            - name: Setup Transifex
              if: always()
              run:
                  touch .transifexrc; echo "[https://www.transifex.com]" >
                  .transifexrc; echo "api_hostname = https://api.transifex.com"
                  >> .transifexrc; echo "hostname = https://www.transifex.com"
                  >> .transifexrc; echo "password =" "${{secrets.TRANSIFEX}}" >>
                  .transifexrc; echo "username = api" >> .transifexrc;

            - name: Push
              if: always()
              run:
                  tx push --source --translations --no-interactive --force
                  --skip

            - name: Pull
              if: always()
              run:
                  tx pull --all --source --skip --no-interactive --force
                  --mode=onlytranslated

            - name: Commit
              if: always()
              id: commit
              uses: stefanzweifel/git-auto-commit-action@master
              with:
                  commit_message: "Synchronize strings with Transifex"
                  branch: main
                  commit_options: "--signoff"
                  commit_user_name: wgytbot
                  commit_user_email: 83586655+wgytbot@users.noreply.github.com
                  commit_author:
                      wgytbot <83586655+wgytbot@users.noreply.github.com>

            - name: Repository Dispatch
              if: steps.commit.outputs.changes_detected == 'false'
              uses: peter-evans/repository-dispatch@v1
              with:
                  token: ${{secrets.WGYTBOT}}
                  event-type: lint
